<html>
<head>
  <title>4sq menorah</title>
  <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css"/>
<link type="text/css" rel="stylesheet" media="all" href="/static/style.css"/>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script type="text/javascript" src="/static/script.js"></script>
</head>
<body>
  <div id="wrapper" class="container-fluid">
    <div id="loading">
      loading...
    </div>
    <div id="herenow" style="display:none">
      <div id="lastCheckin">
          <div id="picWrapper">
            <img id="userPic" src=""/>
            <img id="userCrown" src="/static/crown.png"/>
          </div>
          <h1 id="message"></h1>
      </div>
      <div id="herenow">
        <div id="people"></div>
        <h2><span id="count">0</span> here @ <span id="placeName"></h2>
      </div>
    </div>
    <div id="connect" style="display:none">
      To use this widget, you need to connect to foursquare.<br />
      <a id="connectLink"><img src="/static/connect-white.png" /></a>
    </div>
  </div>

<script type="text/javascript">
  $(function(){
	  // Channel business
	  var connected = false;
	  var vid = '';
  	// Fetch the whole herenow for a venue and load it in (1 time every 2 minutes)
  	var loadHereNow = function(firstTime) {
  	  // If the channel is closed, request the server to send us a new one
  	  var tackOn = '';
  	  if (!connected) { tackOn = '&channel=request'; }
  	  $.getJSON('/herenow?vid='+vid+tackOn, function(data) {
  	    // Handle opening the channel on our end if we just got a new one
  	    if (!(typeof(data.token) === 'undefined')) { refreshChannel(data.token); }
  	    
  	    if (firstTime) { updatePush(data.checkins[0]); }
  
  	    // Load all the contents in at once to avoid a cascade flicker
  	    var newContents = $('<div></div>');
  	    for (c in data.checkins) {
  	      var checkin = data.checkins[c]
  	      var personCard = $('<div class="person"></div>');
  	      personCard.append($('<img src="'+checkin.photo+'"/><div class="name">'+checkin.name+'</div>'));
  	      if (checkin.isMayor) {
  	        personCard.addClass('isMayor');
  	        personCard.prepend('<img id="userCrown" src="/static/crown.png"/>');
  	      }
  	      newContents.append(personCard)
  	    }
  	    
  	    $('#count').html(data.herenow + " people");
  	    $('#people').html(newContents);
  
  	    window.setTimeout(loadHereNow, 120000);
  	  })
  	}
  
  	// Load in the data from a new checkin
  	var updatePush = function(checkin) {
  	  $('#userPic').attr('src', checkin.photo);
  	  if (checkin.isMayor) {
  	    $('#picWrapper').addClass('isMayor');
  	    $('#message').html('All hail his royal highness, <span class="name">'
  	        + checkin.name + '</span>!');
  	  } else {
  	    $('#picWrapper').removeClass('isMayor');
  	    $('#message').html('Everyone say hi to your new friend, <span class="name">'
  	        + checkin.name + '</span>. Clap, clap!');
  	  }
  	}
    
  	// Handle opening a new channel in the event that it needs to be refreshed on the fly
  	function refreshChannel(token) {
      var channel = new goog.appengine.Channel(token);
      socket = channel.open();
      socket.onopen = function() { connected = true; };
      socket.onmessage = function(data) { 
    	  updatePush($.parseJSON(data.data)); 
    	}
  	  socket.onerror = function() {
  	    socket.close();
  	    connected = false;
  	  };
  	  socket.onclose = function() { connected = false; };
  	}
  	
  	var tokenParam = '';
    if (window.location.hash.indexOf("#access_token=") == 0) {
    	tokenParam = '?' + window.location.hash.substring(1);
    }
  	
	  $.getJSON('/connect' + tokenParam, function(data) {
		  
		  if (data.authed){
			  if (data.loginUrl) {
				  $('#loading').text('redirecting to login');
				  window.location = data.loginUrl;
			  } else {
				  $('#loading').hide()
	        refreshChannel(data.token);
				  vid = data.vid;
				  $('#placeName').text(data.venuename);
	        loadHereNow(true);
	        $('#herenow').show();
			  }
		  } else {
			  $('#loading').hide()
			  $('#connectLink').attr('href', data.connectUrl);
			  $('#connect').show();
		  }
	  });
  });
</script>
</body>
</html>
